---
name: Windows Test
on:
  push:
    branches:
      - ae-workflow
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:
jobs:
  test:
    name: Windows Installation
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run scripts to install on windows
      run: |
        Write-Host "Git branch for Run action "${Env:GIT_BRANCH}
        #
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        Get-ChildItem -Path .\windows –recurse
        .\windows\install_oqmbtk.ps1
        $MYPATH = $HOME + "\mbtk"
        Write-Host "Print USERPROFILE folder: $env:USERPROFILE"
        Write-Host "Print MYPATH folder: $MYPATH"
        $Env:PATH += ";$MYPATH"
        $Env:PATH += ";$MYPATH\Scripts"
        $Env:PYTHONUTF8=1
        $Env:PY_PIP=$MYPATH += '\Scripts'
        $Env:PY_HOME=$MYPATH
        $Env:PY_LIBS="$MYPATH\Lib;$MYPATH\Lib\site-package"
        Write-Host "MYPATH Directory: $MYPATH"
        Start-Job -ScriptBlock{& 'oq.exe' dbserver start}
        sleep 15
        oq.exe --version
        Write-Host "Print all environments variables to check"
        dir env:
        Write-Host "Print all pypip packages"
        pip freeze
        pip list
        $MBTK = $HOME + "\mbtk"
        Write-Host "MBTK Directory: $MBTK"
        Set-Location -Path $MBTK
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        Get-ChildItem -Path .\windows –recurse
        cd oq-mbtk\openquake
        pytest -vs --color=yes --durations=10 mbt
        #pytest -vs --color=yes --durations=10 cat ghm man mbt sub wkf smt
