---
name: Windows Test
on:
  push:
    branches:
      - test
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:
jobs:
  test:
    name: Windows Installation
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Installation of GMT from standalone
      run: |
        Invoke-WebRequest -Uri "https://github.com/GenericMappingTools/gmt/releases/download/6.4.0/gmt-6.4.0-win64.exe" -OutFile $HOME\gmt.exe
        cd $HOME
        $Install = Get-ChildItem -Filter gmt*.exe
        Start-Process -FilePath $Install.Fullname -ArgumentList "/S" -Wait
        $Env:PATH += ";C:\programs\gmt6\bin"
        Write-Host ${env:PATH}
    - name: Run scripts to install on windows
      run: |
        Write-Host "Set LIBRARY PATH for GMT"
        $Env:GMT_LIBRARY_PATH="C:\programs\gmt6\bin"
        Write-Host "Git branch for Run action "${Env:GIT_BRANCH}
        #
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        Get-ChildItem -Path .\windows â€“recurse
        .\windows\install_oqmbtk.ps1
        $MYPATH = $HOME + "\mbtk"
        Write-Host "Print USERPROFILE folder: $env:USERPROFILE"
        Write-Host "Print MYPATH folder: $MYPATH"
        $Env:PATH += ";$MYPATH"
        $Env:PATH += ";$MYPATH\Scripts"
        $Env:PYTHONUTF8=1
        $Env:PY_PIP=$MYPATH += '\Scripts'
        $Env:PY_HOME=$MYPATH
        $Env:PY_LIBS="$MYPATH\Lib;$MYPATH\Lib\site-package"
        Write-Host "MYPATH Directory: $MYPATH"
        Start-Job -ScriptBlock{& 'oq.exe' dbserver upgrade}
        oq.exe --version
        Write-Host "Print all environments variables to check"
        dir env:
        Write-Host "Print all pypip packages"
        pip list
        $MBTK = $HOME + "\mbtk"
        Write-Host "MBTK Directory: $MBTK"
        Set-Location -Path $MBTK
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        cd oq-mbtk\openquake
        pytest -vs --color=yes --durations=10 cat ghm man mbt sub wkf smt
