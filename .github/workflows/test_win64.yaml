name: Installation and test on Windows

on:
  push:
    branches:
      - 'ae-310action'
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:
jobs:

  test:
    name: Windows Installation
    runs-on: windows-latest

    steps:
    - name: Extract branch name
      shell: bash
      run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
      id: extract_branch
    - uses: actions/checkout@v3
    - name: Run scripts to install on windows
      run: |
        Write-Host "Git branch for Run action "${Env:GIT_BRANCH}
        #
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        Get-ChildItem -Path .\windows –recurse
        .\windows\install_oqmbtk.ps1
        $mypath = $env:USERPROFILE += "\mbtk"
        $Env:PATH += ";$mypath"
        $Env:PATH += ";$mypath\Scripts"
        $Env:PYTHONUTF8=1
        $Env:PY_PIP=$mypath += '\Scripts'
        $Env:PY_HOME=$mypath
        $Env:PY_LIBS="$mypath\Lib;$mypath\Lib\site-package"
        Start-Job -ScriptBlock{& 'oq.exe' dbserver start}
        sleep 15
        oq.exe --version
        Write-Host "Print all environments variables to check"
        dir env:
        Write-Host "Print all pypip packages"
        pip freeze
        pip list
        Write-Host "Print MyPath folder: $mypath"
        Set-Location -Path $mypath
        $curDir = Get-Location
        Write-Host "Current Working Directory: $curDir"
        Get-ChildItem -Path .\windows –recurse
        cd oq-mbtk\openquake
        pytest -vs --color=yes --durations=10 cat ghm man mbt sub wkf smt 
