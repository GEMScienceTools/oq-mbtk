name: test and make pages

on:
  push:
    branches: [ numpy2_test ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  test:
    name: hazard test
    runs-on: ubuntu-latest
    env:
      MPLBACKEND: 'Agg'
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        git clone --depth=1 https://github.com/gem/oq-engine.git
        cd oq-engine
        python3 install.py devel --version=ae_numpy2
        cd ..
        source ~/openquake/bin/activate
        pip list
        pip install -e .
        pip install pytest
    - name: Run test with pytest
      run: |
        source ~/openquake/bin/activate
        oq engine --upgrade-db
        oq --version
        sleep 3
        cd openquake
        export MPLBACKEND=Agg
        pytest -vsx --color=yes cat ghm man mbi mbt sub wkf smt
